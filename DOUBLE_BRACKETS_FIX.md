# Исправление проблемы с двойными фигурными скобками в плейсхолдере {Table}

## Проблема
При формировании отчета из шаблона создается неправильный плейсхолдер `{{Table}` (с двойными фигурными скобками) вместо `{Table}`, что приводит к повреждению DOCX файла и невозможности его открытия в Microsoft Word.

## Анализ логов
Из логов видно:
```
Initial placeholders in document: (15) ['{Object}', '{System}', '{NameTest}', '{Limits}', '{{Table}', '{Result}', ...]
```

Проблема возникает в функции нормализации плейсхолдеров, которая добавляет лишние фигурные скобки.

## Внесенные исправления

### 1. Улучшенные регулярные выражения в предварительной обработке:
```typescript
// Ищем случаи, где Table может быть просто "Table" без фигурных скобок (но не внутри уже существующих плейсхолдеров)
const tableNoBrackets = /(?<!\{)Table(?!\})/gi;
result = result.replace(tableNoBrackets, '{Table}');
```

### 2. Улучшенные регулярные выражения в основной нормализации:
```typescript
// Специальная обработка для Table - ищем разбитые варианты
if (placeholder === 'Table') {
  // Ищем случаи, где может быть просто "Table" без фигурных скобок (но не внутри уже существующих плейсхолдеров)
  const tableNoBrackets = /(?<!\{)Table(?!\})/gi;
  result = result.replace(tableNoBrackets, '{Table}');
  
  // Ищем случаи, где Table может быть в XML тегах
  const tableInXml = /<w:t[^>]*>Table<\/w:t>/gi;
  result = result.replace(tableInXml, '<w:t>{Table}</w:t>');
}
```

### 3. Исправление уже созданных неправильных плейсхолдеров:
```typescript
// Исправляем неправильные плейсхолдеры с двойными скобками
result = result.replace(/\{\{Table\}\}/g, '{Table}');
result = result.replace(/\{\{Table\}/g, '{Table}');
result = result.replace(/\{Table\}\}/g, '{Table}');
```

### 4. Дополнительное исправление в processTextPlaceholders:
```typescript
// Исправляем неправильные плейсхолдеры с двойными скобками перед обработкой
result = result.replace(/\{\{Table\}\}/g, '{Table}');
result = result.replace(/\{\{Table\}/g, '{Table}');
result = result.replace(/\{Table\}\}/g, '{Table}');
```

## Ключевые изменения

### 1. Использование негативных lookbehind и lookahead:
- `(?<!\{)` - не должно быть `{` перед `Table`
- `(?!\})` - не должно быть `}` после `Table`
- Это предотвращает добавление скобок к уже существующим плейсхолдерам

### 2. Множественные исправления:
- Исправление `{{Table}}` → `{Table}`
- Исправление `{{Table}` → `{Table}`
- Исправление `{Table}}` → `{Table}`

### 3. Применение исправлений в нескольких местах:
- В функции `normalizePlaceholders()`
- В функции `processTextPlaceholders()`

## Ожидаемые результаты

### При следующем запуске в консоли должно появиться:
```
Initial placeholders in document: (15) ['{Object}', '{System}', '{NameTest}', '{Limits}', '{Table}', '{Result}', ...]
```

Вместо:
```
Initial placeholders in document: (15) ['{Object}', '{System}', '{NameTest}', '{Limits}', '{{Table}', '{Result}', ...]
```

## Тестирование

### Шаг 1: Запустите формирование отчета
1. Откройте приложение
2. Загрузите шаблон с плейсхолдером `{Table}`
3. Нажмите "Сформировать отчет"

### Шаг 2: Проверьте консоль браузера
Ищите правильные плейсхолдеры без двойных скобок:
- `Initial placeholders in document: ['{Object}', '{Table}', ...]`
- `Document contains {Table}: true`
- `{Table} placeholder replaced successfully`

### Шаг 3: Проверьте результат
1. Скачайте сформированный отчет
2. Попробуйте открыть его в Microsoft Word
3. Убедитесь, что файл открывается без ошибок
4. Проверьте, что таблица результатов анализа вставлена корректно

## Заключение

Исправления должны решить проблему с повреждением DOCX файлов. Теперь система:

1. **Правильно обрабатывает** плейсхолдер `Table` без создания двойных скобок
2. **Исправляет** уже созданные неправильные плейсхолдеры
3. **Создает корректные** DOCX файлы, которые можно открыть в Microsoft Word
4. **Вставляет таблицу** результатов анализа в правильном формате

После тестирования DOCX файлы должны открываться без ошибок и содержать корректно отформатированную таблицу результатов анализа.








