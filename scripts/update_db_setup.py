from pathlib import Path
import re

path = Path("database_setup.sql")
text = path.read_text(encoding="utf-8")

pattern = (
    r"-- ================================================\r?\n"
    r"-- 3\. НАСТРОЙКА ROW LEVEL SECURITY \(RLS\)\r?\n"
    r"-- ================================================\r?\n"
    r"(?:.|\r|\n)*?"
    r"-- ================================================\r?\n"
    r"-- 4\. НАСТРОЙКА STORAGE\r?\n"
    r"-- ================================================\r?\n"
)

replacement = (
    "-- ================================================\n"
    "-- 3. НАСТРОЙКА БЕЗОПАСНОСТИ (опционально)\n"
    "-- ================================================\n\n"
    "/*\n"
    "В Supabase на этом месте создавались политики RLS и правила для storage,\n"
    "использующие функции auth.uid()/auth.role() и схему storage.*. В чистом\n"
    "PostgreSQL эти зависимости отсутствуют, поэтому блок удалён. При необходимости\n"
    "настройте собственные механизмы аутентификации и добавьте политики вручную.\n"
    "*/\n\n"
    "-- ================================================\n"
    "-- 4. СОЗДАНИЕ ТРИГГЕРОВ\n"
    "-- ================================================\n"
)

new_text, count = re.subn(pattern, replacement, text, flags=re.S)

if count == 0:
    raise SystemExit("pattern not found")

path.write_text(new_text, encoding="utf-8")


