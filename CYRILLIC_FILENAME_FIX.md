# Исправление проблемы с кириллическими именами файлов

## Проблема

При загрузке файлов с кириллическими именами возникала ошибка:
```
POST https://rcplxggzlkqsypffugno.supabase.co/storage/v1/object/qualification-ob…%B8%20%D0%BE%D1%82%D1%87%D0%B5%D1%82%20%D0%BB%D0%B5%D1%82%D0%BE%202025.png 400 (Bad Request)
Error: Ошибка загрузки файла плана: Invalid key: plans/f200231d-6158-4c60-88ad-1a9aec55898c/1759172406487-МедФарминвест помещение приемки отчет лето 2025.png
```

## Причина

Supabase Storage не поддерживает кириллические символы и специальные символы (пробелы, знаки препинания) в URL-путях файлов. Имя файла "МедФарминвест помещение приемки отчет лето 2025.png" содержит:
- Кириллические символы (МедФарминвест, помещение, приемки, отчет, лето)
- Пробелы
- Цифры

## Решение

Создана система очистки имен файлов, которая:
1. Транслитерирует кириллические символы в латинские
2. Заменяет специальные символы на подчеркивания
3. Ограничивает длину имени файла
4. Сохраняет расширение файла

### Созданная утилита

**Файл:** `src/utils/fileNameUtils.ts`

```typescript
export function sanitizeFileName(fileName: string): string {
  // Получаем расширение файла
  const lastDotIndex = fileName.lastIndexOf('.');
  const extension = lastDotIndex !== -1 ? fileName.substring(lastDotIndex) : '';
  const nameWithoutExtension = lastDotIndex !== -1 ? fileName.substring(0, lastDotIndex) : fileName;
  
  // Заменяем кириллические символы на латинские аналоги
  const transliterated = nameWithoutExtension
    .replace(/[а-яё]/gi, (char) => {
      const map: { [key: string]: string } = {
        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo',
        'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
        'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
        'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch',
        'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya',
        // ... заглавные буквы
      };
      return map[char] || char;
    })
    // Заменяем пробелы и специальные символы на подчеркивания
    .replace(/[\s\-\.\,\!\?\:\;\(\)\[\]\{\}\+\=\*\/\\\|\<\>\@\#\$\%\^\&\~\`]/g, '_')
    // Удаляем множественные подчеркивания
    .replace(/_+/g, '_')
    // Удаляем подчеркивания в начале и конце
    .replace(/^_+|_+$/g, '')
    // Ограничиваем длину имени файла
    .substring(0, 100);
  
  return transliterated + extension;
}
```

### Примеры преобразования

| Исходное имя | Очищенное имя |
|-------------|---------------|
| `МедФарминвест помещение приемки отчет лето 2025.png` | `MedFarminvest_pomeschenie_priemki_otchet_leto_2025.png` |
| `Документ с пробелами и символами!.pdf` | `Dokument_s_probelyami_i_simvolami.pdf` |
| `файл с кириллицей.docx` | `fail_s_kirillicey.docx` |

### Обновленные сервисы

1. **qualificationObjectService.ts**
   - Методы `uploadPlanFile()` и `uploadTestDataFile()`
   - Используют `sanitizeFileName()` для очистки имен файлов

2. **enhancedProjectDocumentService.ts**
   - Метод `uploadDocument()`
   - Очищает исходное имя файла перед генерацией уникального имени

3. **projectDocumentService.ts**
   - Метод `uploadDocument()`
   - Применяет очистку к именам файлов документов

4. **testingPeriodService.ts**
   - Метод `uploadTestingPeriodDocument()`
   - Очищает имена файлов документов испытаний

## Логика работы

### До исправления:
```typescript
const fileName = `plans/${objectId}/${Date.now()}-${file.name}`;
// Результат: "plans/123/1759172406487-МедФарминвест помещение приемки отчет лето 2025.png"
// ❌ Ошибка: Invalid key (кириллица и пробелы)
```

### После исправления:
```typescript
const sanitizedFileName = sanitizeFileName(file.name);
const fileName = `plans/${objectId}/${Date.now()}-${sanitizedFileName}`;
// Результат: "plans/123/1759172406487-MedFarminvest_pomeschenie_priemki_otchet_leto_2025.png"
// ✅ Успешно: только латинские символы и подчеркивания
```

## Преимущества решения

1. **Совместимость с Supabase Storage** - все имена файлов содержат только допустимые символы
2. **Читаемость** - транслитерация сохраняет смысл исходного имени
3. **Уникальность** - временная метка гарантирует уникальность
4. **Безопасность** - удаление специальных символов предотвращает проблемы с безопасностью
5. **Универсальность** - функция может использоваться во всех сервисах загрузки файлов

## Файлы изменены:
- `src/utils/fileNameUtils.ts` - новая утилита для очистки имен файлов
- `src/utils/qualificationObjectService.ts` - обновлены методы загрузки файлов
- `src/utils/enhancedProjectDocumentService.ts` - обновлен метод загрузки документов
- `src/utils/projectDocumentService.ts` - обновлен метод загрузки документов
- `src/utils/testingPeriodService.ts` - обновлен метод загрузки документов испытаний

## Результат:
- ✅ Файлы с кириллическими именами успешно загружаются
- ✅ Специальные символы корректно обрабатываются
- ✅ Сохраняется читаемость имен файлов
- ✅ Все сервисы загрузки файлов обновлены
- ✅ Универсальное решение для всех типов файлов

## Тестирование:
1. Попробуйте загрузить файл с кириллическим именем (например: "МедФарминвест помещение приемки отчет лето 2025.png")
2. Убедитесь, что файл успешно загружается без ошибок
3. Проверьте, что в Storage сохраняется очищенное имя файла
4. Убедитесь, что файл доступен по ссылке и открывается корректно























