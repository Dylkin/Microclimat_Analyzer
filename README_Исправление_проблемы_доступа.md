# Исправление проблемы "Доступ запрещен"

## Проблема
Пользователь получает сообщение "Доступ запрещен" даже после обновления роли на администратора.

## Причина
Несоответствие между ролями в базе данных и в коде приложения:
- В базе данных устанавливается роль `'admin'`
- В коде приложения проверяется роль `'administrator'`

## Решение

### 1. Выполните SQL скрипт для проверки и исправления

Выполните скрипт `check_user_access.sql` в Supabase SQL Editor. Этот скрипт:
- Проверит структуру таблицы `users`
- Проверит данные пользователя в обеих таблицах
- Добавит пользователя в `public.users` если он отсутствует
- Обновит роль на `'admin'` в обеих таблицах

### 2. Обновлен код приложения

В файлах `src/contexts/AuthContext.tsx` и `src/components/Layout.tsx`:
- ✅ Добавлена поддержка роли `'admin'` в функции `hasAccess`
- ✅ Добавлено логирование для диагностики
- ✅ Обновлена функция `getRoleLabel` для отображения роли

### 3. Перезайдите в систему

После выполнения SQL скрипта:
1. **Выйдите из системы** (нажмите "Выйти")
2. **Войдите заново** с теми же учетными данными
3. **Проверьте консоль браузера** - должны появиться логи с информацией о роли пользователя

## Диагностика

### Проверьте логи в консоли браузера
После входа в систему в консоли должны появиться логи:
```
hasAccess: проверка доступа для пользователя: {
  user: "pavel.dylkin@gmail.com",
  role: "admin",
  page: "analyzer"
}
```

### Если роль все еще не определяется правильно:
1. **Очистите localStorage**: `localStorage.clear()`
2. **Перезагрузите страницу**
3. **Войдите заново**

### Проверьте данные в базе данных
```sql
-- Проверяем роль в public.users
SELECT email, role FROM public.users WHERE email = 'pavel.dylkin@gmail.com';

-- Проверяем роль в auth.users
SELECT email, raw_user_meta_data->>'role' as role 
FROM auth.users WHERE email = 'pavel.dylkin@gmail.com';
```

## Поддерживаемые роли

- `'admin'` - Полный доступ ко всем функциям
- `'administrator'` - Полный доступ ко всем функциям (совместимость)
- `'specialist'` - Доступ к анализатору, справке и базе данных
- `'manager'` - Доступ к анализатору, справке и базе данных
- `'director'` - Доступ к анализатору, справке и базе данных
- `'user'` - Доступ только к справке

## Файлы изменений

- `check_user_access.sql` - SQL скрипт для диагностики и исправления
- `src/contexts/AuthContext.tsx` - добавлена поддержка роли `'admin'`
- `src/components/Layout.tsx` - обновлена функция `getRoleLabel`
- `README_Исправление_проблемы_доступа.md` - инструкции

## Следующие шаги

1. **Выполните SQL скрипт** `check_user_access.sql`
2. **Выйдите и войдите заново** в систему
3. **Проверьте логи** в консоли браузера
4. **Проверьте доступ** - теперь должны быть доступны все функции

После выполнения этих шагов пользователь должен получить полный доступ к системе!



















