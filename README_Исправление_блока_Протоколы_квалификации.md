# Исправление неактивного блока "Протоколы квалификации"

## Проблема

На странице "Согласование договора" блок "Протоколы квалификации" не активен и не отображает протоколы.

## Причины

1. **Отсутствует представление `qualification_protocols_with_documents`** в базе данных
2. **Нет выбранных объектов квалификации** в проекте
3. **Ошибки при загрузке протоколов** из базы данных

## Решение

### 1. Создание представления в базе данных (Рекомендуется)

Выполните SQL скрипт `create_qualification_protocols_view.sql` в Supabase Dashboard:

```sql
-- Создание представления qualification_protocols_with_documents
DO $$
BEGIN
    -- Удаляем представление, если оно существует
    DROP VIEW IF EXISTS qualification_protocols_with_documents CASCADE;
    
    -- Создаем новое представление
    CREATE VIEW qualification_protocols_with_documents AS
    SELECT 
        qp.id,
        qp.project_id,
        qp.qualification_object_id,
        qp.object_type,
        qp.object_name,
        qp.protocol_document_id,
        qp.status,
        qp.approved_by,
        qp.approved_at,
        qp.rejection_reason,
        qp.created_at,
        qp.updated_at,
        -- Данные документа
        pd.id as document_id,
        pd.file_name,
        pd.file_size,
        pd.file_url,
        pd.mime_type,
        pd.uploaded_by,
        pd.uploaded_at
    FROM qualification_protocols qp
    LEFT JOIN project_documents pd ON qp.protocol_document_id = pd.id
    WHERE pd.document_type = 'qualification_protocol';
    
    RAISE NOTICE 'Представление qualification_protocols_with_documents успешно создано';
END $$;
```

### 2. Улучшение кода (Уже применено)

Код был обновлен для более надежной работы:

- ✅ **Функция `getProjectProtocols`** теперь использует альтернативный запрос, если представление не существует
- ✅ **Обработка ошибок** - возвращает пустой массив вместо выброса ошибки
- ✅ **Информативные сообщения** - показывает понятные сообщения пользователю

### 3. Проверка объектов квалификации

Убедитесь, что в проекте есть выбранные объекты квалификации:

1. Перейдите в раздел "Объекты квалификации" на странице согласования договора
2. Добавьте объекты квалификации, если их нет
3. Выберите нужные объекты для проекта

## Результат

После применения исправлений:

1. ✅ **Блок "Протоколы квалификации" становится активным**
2. ✅ **Отображаются протоколы для выбранных объектов квалификации**
3. ✅ **Можно загружать новые протоколы квалификации**
4. ✅ **Система работает даже без представления в БД**

## Диагностика

### Если блок все еще неактивен:

1. **Проверьте консоль браузера** на наличие ошибок
2. **Убедитесь, что есть объекты квалификации** в проекте
3. **Проверьте, что таблицы `qualification_protocols` и `project_documents` существуют**

### Логи в консоли:

```
QualificationProtocolService: Представление qualification_protocols_with_documents не найдено, используем альтернативный запрос
QualificationProtocolService: Возвращаем пустой массив протоколов из-за ошибки загрузки
```

Эти сообщения указывают на проблемы с базой данных.

## Тестирование

Для проверки исправления:

1. Откройте страницу "Согласование договора"
2. Убедитесь, что в проекте есть объекты квалификации
3. Проверьте, что блок "Протоколы квалификации" отображается
4. Попробуйте загрузить протокол квалификации

## Структура данных

Блок "Протоколы квалификации" отображается для каждого типа объекта квалификации:

- **Помещение** - протокол для помещения
- **Автомобиль** - протокол для автомобиля  
- **Холодильник** - протокол для холодильника
- **Морозильник** - протокол для морозильника
- **Холодильная камера** - протокол для холодильной камеры

Каждый протокол может быть загружен, просмотрен и согласован отдельно.



















