# Исправление отображения статуса документов

## Проблема
Статус коммерческого предложения отображался неправильно. В истории согласований показано, что документ был согласован (зеленая галочка), но статус в правом верхнем углу все еще показывал "Ожидает согласования".

## Причина
В функции `renderDocumentSection` компонента `DocumentApproval` использовался неправильный параметр для определения статуса:

```typescript
// НЕПРАВИЛЬНО - использовался isApproved из локального состояния
{getStatusIcon(!!document, isApproved)}
{getStatusText(!!document, isApproved)}
{getStatusColor(!!document, isApproved)}

// ПРАВИЛЬНО - должен использоваться currentStatus из базы данных
{getStatusIcon(!!document, currentStatus === 'approved')}
{getStatusText(!!document, currentStatus === 'approved')}
{getStatusColor(!!document, currentStatus === 'approved')}
```

## Решение

### 1. Исправлена логика отображения статуса
В файле `src/components/contract/DocumentApproval.tsx`:

- **Строки 230, 233, 234**: Заменено использование `isApproved` на `currentStatus === 'approved'`
- **Строки 388-396**: Исправлена аналогичная проблема в блоке протоколов квалификации

### 2. Добавлено отладочное логирование
Для диагностики проблем с загрузкой статусов добавлены console.log:

- **Строки 95-99**: Логирование загрузки статусов документов
- **Строки 83-89**: Логирование загруженных статусов из базы данных
- **Строки 235-240**: Логирование определения статуса для каждого документа

## Логика определения статуса

Статус документа определяется по следующему приоритету:

1. **Первый приоритет**: Статус из базы данных (`dbStatus?.status`)
2. **Второй приоритет**: Локальное состояние (`isApproved ? 'approved' : 'pending'`)

```typescript
const currentStatus = dbStatus?.status || (isApproved ? 'approved' : 'pending');
```

## Функции отображения статуса

- `getStatusIcon(hasDocument, isApproved)` - возвращает иконку статуса
- `getStatusText(hasDocument, isApproved)` - возвращает текст статуса
- `getStatusColor(hasDocument, isApproved)` - возвращает CSS классы для цвета

### Возможные статусы:
- **"Согласовано"** (зеленый) - документ согласован
- **"Ожидает согласования"** (желтый) - документ загружен, но не согласован
- **"Ожидает загрузки"** (серый) - документ не загружен

## Проверка результата

После исправления:

1. Откройте страницу "Согласование договора"
2. Проверьте консоль браузера на наличие отладочных сообщений:
   - `DocumentApproval: Загружаем статусы документов`
   - `DocumentApproval: Загружен статус для документа [ID]: [статус]`
   - `DocumentApproval: Статус для [название] ([ID]): {dbStatus, isApproved, currentStatus}`
3. Убедитесь, что статус в правом верхнем углу соответствует реальному статусу из истории согласований

## Файлы изменений

- `src/components/contract/DocumentApproval.tsx` - основное исправление логики отображения статуса

## Примечания

- Отладочные сообщения можно удалить после подтверждения корректной работы
- Исправление затрагивает как коммерческие предложения, так и договоры
- Аналогичная проблема была исправлена и для протоколов квалификации



















