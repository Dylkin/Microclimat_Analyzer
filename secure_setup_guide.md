# Руководство по безопасной настройке Storage

## Обзор
Это руководство описывает настройку безопасной загрузки файлов в Supabase Storage с использованием аутентификации и RLS политик.

## Требования безопасности
- ✅ Приватный bucket (не публичный)
- ✅ RLS политики для авторизованных пользователей
- ✅ Email/password аутентификация
- ✅ Отсутствие анонимного доступа
- ✅ Безопасная загрузка/скачивание файлов

## Шаг 1: SQL Конфигурация

### 1.1 Откройте Supabase Dashboard
1. Перейдите на https://supabase.com/dashboard
2. Войдите в свой аккаунт
3. Выберите ваш проект

### 1.2 Выполните SQL скрипт
1. В левом меню нажмите "SQL Editor"
2. Нажмите "New query"
3. Скопируйте и выполните содержимое файла `secure_storage_setup.sql`

### 1.3 Проверьте результат
После выполнения скрипта должны быть созданы:
- Приватный bucket 'documents'
- RLS политики для авторизованных пользователей
- Безопасные настройки доступа

## Шаг 2: Настройка аутентификации

### 2.1 Включите Email аутентификацию
1. В Supabase Dashboard перейдите в "Authentication" → "Settings"
2. Убедитесь, что "Enable email confirmations" включен
3. Настройте "Site URL" для вашего приложения

### 2.2 Создайте пользователя (опционально)
1. Перейдите в "Authentication" → "Users"
2. Нажмите "Add user"
3. Создайте тестового пользователя

## Шаг 3: Тестирование в приложении

### 3.1 Откройте Secure Auth Manager
1. Запустите приложение
2. Перейдите в "Secure Auth Manager" в меню
3. Зарегистрируйтесь или войдите в систему

### 3.2 Протестируйте загрузку
1. После успешной аутентификации
2. Нажмите "Тест Secure Storage"
3. Убедитесь, что загрузка работает

### 3.3 Проверьте в приложении
1. Перейдите на страницу "Согласование договора"
2. Попробуйте загрузить документ
3. Загрузка должна работать без ошибок

## Шаг 4: Проверка безопасности

### 4.1 Проверьте bucket
```sql
SELECT * FROM storage.buckets WHERE id = 'documents';
```
Результат: `public = false`

### 4.2 Проверьте RLS политики
```sql
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE tablename = 'objects' AND schemaname = 'storage';
```

### 4.3 Проверьте аутентификацию
- Попробуйте загрузить файл без входа в систему
- Должна появиться ошибка "Требуется аутентификация"

## Безопасность

### ✅ Что защищено:
- Файлы доступны только авторизованным пользователям
- RLS политики контролируют доступ
- Приватный bucket предотвращает прямой доступ
- Аутентификация обязательна для всех операций

### ⚠️ Важные моменты:
- Регулярно обновляйте пароли пользователей
- Мониторьте логи аутентификации
- Используйте HTTPS в продакшене
- Настройте правильные CORS политики

## Устранение неполадок

### Ошибка "Требуется аутентификация"
- Убедитесь, что пользователь вошел в систему
- Проверьте, что RLS политики созданы правильно

### Ошибка "Bucket не найден"
- Выполните `secure_storage_setup.sql` повторно
- Проверьте, что bucket создан как приватный

### Ошибка "Permission denied"
- Проверьте RLS политики
- Убедитесь, что пользователь аутентифицирован

## Дополнительные настройки

### Настройка ролей пользователей
```sql
-- Создание роли для администраторов
CREATE ROLE admin_role;
GRANT ALL ON storage.objects TO admin_role;

-- Создание роли для обычных пользователей
CREATE ROLE user_role;
GRANT SELECT, INSERT ON storage.objects TO user_role;
```

### Настройка лимитов файлов
```sql
-- Обновление лимита размера файла
UPDATE storage.buckets 
SET file_size_limit = 104857600 -- 100MB
WHERE id = 'documents';
```

## Заключение

После выполнения всех шагов у вас будет:
- Безопасная система загрузки файлов
- Аутентификация пользователей
- RLS политики для контроля доступа
- Приватный Storage bucket
- Соответствие требованиям безопасности


























